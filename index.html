<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BottleNexus Checkout Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      label, input, button {
        font-size: 1rem;
      }
      input {
        margin-right: 10px;
        padding: 5px;
      }
      button {
        padding: 6px 12px;
      }
    </style>
  </head>
  <body>
    <h2>BottleNexus Checkout</h2>
    <label for="productId">Product ID:</label>
    <input type="text" id="productId" placeholder="Enter product ID" value="8740" />
    <button id="checkoutBtn">Add to Cart & Checkout</button>

    <script>
      (async function () {
        const config = {
          token: "b1ef889a-6b98-11ef-9e5f-0242ac110002",
          options: {},
        };

        const API_BASE = "https://api.bottlenexus.com/";
        const CHECKOUT_BASE = "https://checkout.bottlenexus.com/";

        async function getHeaders() {
          return {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${config.token}`,
          };
        }

        async function validateCheckout(checkoutId) {
          try {
            const response = await fetch(API_BASE + "api/v1/checkout/" + checkoutId + "/", {
              headers: await getHeaders(),
            });
            return response.ok;
          } catch {
            return false;
          }
        }

        async function createCheckout() {
          const metadata = {};
          const options = config.options || {};

          const response = await fetch(API_BASE + "api/v1/checkout/create/", {
            method: "POST",
            headers: await getHeaders(),
            body: JSON.stringify({ metadata, options }),
          });

          if (!response.ok) throw new Error("Failed to create checkout: " + response.status);
          const data = await response.json();
          if (!data.checkout_id) throw new Error("Response did not contain a checkout_id");

          console.log("Created new checkout:", data.checkout_id);
          return data.checkout_id;
        }

        async function createProduct(productId, quantity = 1, recurrence = "one-time") {
          let checkoutId = localStorage.getItem("checkoutId");

          // Validate or create checkout session
          if (!checkoutId || !(await validateCheckout(checkoutId))) {
            checkoutId = await createCheckout();
            localStorage.setItem("checkoutId", checkoutId);
          }

          const payload = {
            quantity,
            recurrence,
            engraving_lines: null,
          };

          const url = `${API_BASE}api/v1/checkout/${checkoutId}/${productId}/create/`;
          const response = await fetch(url, {
            method: "POST",
            headers: await getHeaders(),
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const errText = await response.text();
            throw new Error(`Failed to add product: ${response.status} - ${errText}`);
          }

          const data = await response.json();
          console.log("Product added:", data);
          return { checkoutId, data };
        }

        async function handleCheckout() {
          const productInput = document.getElementById("productId");
          const productId = productInput.value.trim();
          if (!productId) {
            alert("Please enter a product ID.");
            return;
          }

          try {
            const { checkoutId } = await createProduct(productId, 1, "one-time");
            const checkoutUrl = `${CHECKOUT_BASE}checkout/${checkoutId}/`;
            console.log("Opening checkout:", checkoutUrl);
            window.open(checkoutUrl, "_blank");
          } catch (error) {
            console.error("Checkout Error:", error);
            alert("Error: " + error.message);
          }
        }

        document.getElementById("checkoutBtn").addEventListener("click", handleCheckout);
      })();
    </script>
  </body>
</html>
